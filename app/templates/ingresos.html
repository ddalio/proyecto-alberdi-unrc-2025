{% extends 'base.html' %}
{% block title%} Ingresos {% endblock %}

{% block content %}

{% with mensajes = get_flashed_messages(with_categories=true) %}
  {% if mensajes %}
    {% for categoria, mensaje in mensajes %}
      <div class="alert alert-{{ categoria }}">{{ mensaje }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}


<div class="container py-3">
  <div class="d-flex align-items-center mb-3">
    <a href="{{ url_for('auth.inicio') }}" class="text-muted me-3" aria-label="Volver">
      <i class="bi bi-arrow-left fs-4"></i>
    </a>
    <h3 class="m-0">Ingresos</h3>
  </div>

  <div class="d-flex justify-content-center">
    <div class="card w-100" style="max-width:1100px;">
      <div class="card-body d-flex flex-column" style="min-height:60vh;">
        <!-- Row 1: filtros de fecha -->
        <div class="row mb-3">
          <form class="w-100" method="get" action="{{ url_for('ingresos.rango_eventos_por_fecha') }}">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label class="form-label mb-1">Desde:</label>
                <input type="date" name="desde" class="form-control" value="{{ request.args.get('desde','') }}">
              </div>
              <div class="col-auto">
                <label class="form-label mb-1">Hasta:</label>
                <input type="date" name="hasta" class="form-control" value="{{ request.args.get('hasta','') }}">
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-custom">Filtrar</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Row 2: lista de eventos (tabla con scroll) -->
        <div class="row flex-grow-1 mb-3">
          <div class="col-12">
            <div style="max-height:50vh; overflow:auto;">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-light position-sticky top-0" style="z-index:1;">
                  <tr>
                    <th scope="col">Fecha</th>
                    <th scope="col">Nombre evento</th>
                    <th scope="col" class="text-end">Monto total</th>
                    <th scope="col" class="text-end">Total pagado</th>
                  </tr>
                </thead>
                <tbody>
                  {% for evento in eventos %}
                  <tr>
                    <td>{{ evento.fecha_inicio }}</td>
                    <td>{{ evento.descripcion }}</td>
                    <td class="text-end">{{ evento.monto_total | float | round(2) }}</td>
                    <td class="text-end">{{ evento.total_pagado | float | round(2) }}</td>
                    <td class="acciones">
                      <a href="{{ url_for('ingresos.pagos', id_evento=evento.id_evento) }}" class="me-2" title="Ver pagos">
                        <i class="bi bi-cash-coin"></i>
                      </a>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="4" class="text-center py-4">No hay eventos para las fechas seleccionadas</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Row 3: totales y botÃ³n volver -->
        <div class="row">
          <div class="col-md-8 d-flex flex-column justify-content-center">
            <div class="d-flex flex-column">
              <strong>Resumen:</strong>
              <div class="mt-2">
                <span class="me-3">Suma montos: <span class="fw-bold">
                  {{ (eventos | sum(attribute='monto_total')) | default(0) | float | round(2) }}
                </span></span>
                <span> Suma pagado: <span class="fw-bold">
                  {{ (eventos | sum(attribute='total_pagado')) | default(0) | float | round(2) }}
                </span></span>
              </div>
            </div>
          </div>

          <div class="col-md-4 d-flex justify-content-end align-items-center">
            <a href="{{ url_for('ingresos.ingresos') }}" class="btn btn-outline-secondary">
               <i class="bi bi-arrow-left me-2"></i>Volver</a>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}



