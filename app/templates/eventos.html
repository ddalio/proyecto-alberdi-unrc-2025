{% extends 'base.html' %} {% block title %} Eventos {% endblock %} {% block
content %}

<!-- Toast para mensajes flash -->
<div
  class="toast-container position-fixed top-0 end-0 p-3"
  style="z-index: 1100"
>
  {% with mensajes = get_flashed_messages(with_categories=true) %} {% if
  mensajes %} {% for categoria, mensaje in mensajes %}
  <div
    class="toast show align-items-center text-bg-{{ categoria }} border-0 mb-2"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <div class="d-flex">
      <div class="toast-body">
        <i
          class="bi {% if categoria == 'success' %}bi-check-circle-fill {% elif categoria == 'danger' %}bi-exclamation-triangle-fill {% elif categoria == 'warning' %}bi-exclamation-triangle-fill {% elif categoria == 'info' %}bi-info-circle-fill {% else %}bi-bell-fill{% endif %} me-2"
        ></i>
        {{ mensaje }}
      </div>
      <button
        type="button"
        class="btn-close btn-close-black me-2 m-auto"
        data-bs-dismiss="toast"
        aria-label="Cerrar"
      ></button>
    </div>
  </div>
  {% endfor %} {% endif %} {% endwith %}
</div>
<!-- Modal overlay para "Agregar Pago" (todo inline en esta plantilla) -->
<div
  id="paymentModalOverlay"
  class="d-none"
  aria-hidden="true"
  style="
    position: fixed;
    inset: 0;
    z-index: 1050;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 40px;
    background: rgba(0, 0, 0, 0.5);
  "
>
  <div
    class="card shadow p-4"
    style="width: 92vw; max-width: 900px; max-height: 92vh; overflow: auto"
  >
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="m-0">Nuevo Pago</h5>
      <button
        type="button"
        id="closePaymentModalBtn"
        class="btn btn-close"
        aria-label="Cerrar"
      ></button>
    </div>

    <form id="paymentForm" action="#" method="POST" class="row g-3">
      <!-- CSRF token si aplica -->
      {# {{ csrf_token() }} #}
      <input type="hidden" name="id_evento" id="modal_event_id" />

      <!-- Left: inputs de pago -->
      <div class="col-md-7">
        <div class="mb-2">
          <label class="form-label">Descripción del evento</label>
          <input id="modal_event_desc" class="form-control" readonly />
        </div>

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Monto a Pagar</label>
            <input
              id="modal_monto_pago"
              name="monto_pago"
              type="number"
              step="0.01"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha de pago</label>
            <input
              id="modal_fecha_pago"
              name="fecha_inicio"
              type="date"
              class="form-control"
              required
            />
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-auto">
          <button
            type="button"
            id="cancelPaymentBtn"
            class="btn btn-outline-secondary"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-custom">Crear Pago</button>
        </div>
        <script>
          (function () {
            const s = document.currentScript;
            const col = s.closest(".col-md-7");
            if (col) col.classList.add("d-flex", "flex-column");
          })();
        </script>
      </div>

      <!-- Right: resumen / datos del evento y responsable -->
      <aside class="col-md-5">
        <div class="section-card p-3">
          <h6 class="mb-2">Datos del Evento</h6>
          <p class="mb-1">
            <strong>ID:</strong> <span id="modal_event_id_text">-</span>
          </p>
          <p class="mb-1">
            <strong>Monto total:</strong> $<span id="modal_event_monto"
              >0.00</span
            >
          </p>
          <p class="mb-1">
            <strong>Monto deuda:</strong> $<span id="modal_event_monto_deuda"
              >0.00</span
            >
          </p>
          <p class="mb-1">
            <strong>Adeuda:</strong> <span id="modal_event_adeuda">No</span>
          </p>
        </div>

        <div class="section-card p-3 mt-3">
          <h6 class="mb-2">Vecino</h6>
          <p class="mb-1">
            <strong>Nombre:</strong> <span id="modal_cliente_nombre">-</span>
          </p>
          <p class="mb-1">
            <strong>DNI:</strong> <span id="modal_cliente_dni">-</span>
          </p>
          <p class="mb-1">
            <strong>Responsable Apertura:</strong> <span id="modal_responsable">-</span>
          </p>
        </div>
      </aside>
    </form>
    <div id="montoError" class="alert alert-danger d-none mt-2 mx-3">
      <i class="bi bi-exclamation-triangle me-2"></i>
      El monto a pagar no puede ser mayor al monto que se adeuda del evento
    </div>
    <script>
      document
        .getElementById("paymentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const montoPago = parseFloat(
            document.getElementById("modal_monto_pago").value
          );
          const montoDeuda = parseFloat(
            document.getElementById("modal_event_monto_deuda").textContent
          );
          const errorDiv = document.getElementById("montoError");

          if (montoPago > montoDeuda) {
            errorDiv.classList.remove("d-none");
            return false;
          }

          errorDiv.classList.add("d-none");
          this.submit(); 
        });
    </script>
  </div>
</div>

<div class="container py-3">
  <div class="d-flex align-items-center mb-3">
    <a
      href="{{ url_for('auth.inicio') }}"
      class="text-muted me-3"
      aria-label="Volver"
    >
      <i class="bi bi-arrow-left fs-4"></i>
    </a>
    <h3 class="m-0">Eventos</h3>
  </div>

  <div class="d-flex justify-content-center">
    <div class="card w-100" style="max-width: 1100px">
      <div class="card-body d-flex flex-column" style="min-height: 60vh">
        <!-- Row 1: buscador por DNI y boton de descarga (estética) -->
        <div class="row mb-3">
          <div class="col-12">
            <form
              action="{{ url_for('eventos_bp.buscar_evento_campo') }}"
              method="POST"
              class="d-flex gap-2 align-items-end"
            >
              <!-- Selector de campo -->
              <div>
                <label for="campo" class="form-label mb-1 visually-hidden"
                  >Campo</label
                >
                <select name="campo" id="campo" class="form-select">
                  <option value="dni" 
                          {% if campo == 'dni' %} selected {% endif %}
                  >DNI del Vecino</option>
                  
                  <option value="nombre" 
                          {% if campo == 'nombre' %} selected {% endif %}
                  >Nombre del Vecino</option>
                  
                  <option value="descripcion" 
                          {% if campo == 'descripcion' %} selected {% endif %}
                  >Descripción del Evento</option>
                  
                </select>
              </div>

              <!-- Campo de búsqueda -->
              <div class="flex-grow-1" style="max-width: 420px">
                <label class="form-label mb-1 visually-hidden">Valor</label>
                <input
                  type="search"
                  name="valor"
                  id="valor"
                  class="form-control"
                  placeholder="Buscar..."
                  aria-label="Buscar"
                  value="{{ valor if valor else '' }}"
                />
              </div>

              <!-- Botones -->
              <div class="d-flex align-items-center">
                <button type="submit" class="btn btn-custom me-2">
                  Buscar
                </button>
                <button
                  type="button"
                  id="downloadPdfBtn"
                  class="btn btn-outline-secondary"
                  title="Descargar lista (PDF)"
                >
                  <i class="bi bi-download fs-5"></i>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Row 2: filtros por fecha -->
        <div class="row mb-3">
          <div class="col-12">
            <form 
              action="/eventos/filtrar" method="GET" 
              class="d-flex flex-column flex-sm-row gap-2 "
            >
              <div>
                <label class="form-label mb-1">Desde:</label>
                <input type="date" id="desde" name="desde" class="form-control">
              </div>
              <div>
                <label class="form-label mb-1">Hasta:</label>
                <input type="date" id="hasta" name="hasta" class="form-control">
              </div>
              <div class="align-self-end">
                <button type="submit" class="btn btn-custom">Filtrar</button>
              </div>

          </div>
        </div>

        <!-- Row 3: tabla de eventos con scroll -->
        <div class="row flex-grow-1 mb-3">
          <div class="col-12">
            <div style="max-height: 50vh; overflow: auto">
              <table class="table table-striped table-hover mb-0">
                <thead
                  class="table-light position-sticky top-0"
                  style="z-index: 1"
                >
                  <tr>
                    <th>Descripción</th>
                    <th>DNI</th>
                    <th>Fecha</th>
                    <th>Hora Inicio</th>
                    <th>Hora Fin</th>
                    <th>Vecino</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for evento in eventos %}
                  <tr>
                    <td>{{evento.descripcion}}</td>
                    <td class="td-dni">{{ evento.dni }}</td>
                    <td>
                      {{ evento.fecha_inicio.strftime('%d-%m-%Y') if
                      evento.fecha_inicio else 'N/A' }}
                    </td>
                    <td>
                      {{ evento.fecha_inicio.strftime('%H:%M') if
                      evento.fecha_inicio else 'N/A' }}
                    </td>
                    <td>
                      {{ evento.fecha_fin.strftime('%H:%M') if evento.fecha_fin
                      else 'N/A' }}
                    </td>
                    <td>
                      {{ evento.cliente.nombre }} {{ evento.cliente.apellido }}
                    </td>
                    <td class="acciones">
                      <a
                        href="{{ url_for('eventos_bp.detalles_evento', id_evento=evento.id_evento) }}"
                        class="me-2"
                        title="Ver detalles"
                        ><i class="bi bi-file-text"></i
                      ></a>

                      {% if current_user.es_administrador() %}
                      <!-- botón que abre el modal para agregar pago (no navega) -->
                      {% if evento.adeuda %}
                      <button
                        type="button"
                        class="me-2 btn btn-link p-0 openAddPaymentBtn"
                        title="Agregar pago"
                        data-action="{{ url_for('ingresos.agregar_pago', id_evento=evento.id_evento) }}"
                        data-id="{{ evento.id_evento }}"
                        data-descripcion="{{ evento.descripcion | e }}"
                        data-monto="{{ evento.monto_total }}"
                        data-monto-deuda="{{ evento.monto_deuda }}"
                        data-adeuda="{{ '1' if evento.adeuda else '0' }}"
                        data-cliente-nombre="{{ evento.cliente.nombre if evento.cliente is defined else '' }}"
                        data-cliente-apellido="{{ evento.cliente.apellido if evento.cliente is defined else '' }}"
                        data-cliente-dni="{{ evento.cliente.dni if evento.cliente is defined else '' }}"
                        data-responsable-nombre="{{ evento.responsable_apertura.nombre if evento.responsable_apertura is defined else '' }}"
                        data-responsable-apellido="{{ evento.responsable_apertura.apellido if evento.responsable_apertura is defined else '' }}"
                      >
                        <i class="bi bi-credit-card"></i>
                      </button>
                      {% else %}
                      <button
                        type="button"
                        class="me-2 btn btn-link p-0"
                        title="Pago completo"
                        disabled
                        style="opacity: 0.5; cursor: not-allowed"
                      >
                        <i class="bi bi-credit-card text-muted"></i>
                      </button>
                      {% endif %}

                      <a
                        href="{{ url_for('eventos_bp.editar_evento', id_evento=evento.id_evento) }}"
                        class="me-2"
                        title="Editar evento"
                        ><i class="bi bi-pencil"></i
                      ></a>

                      <form
                        action="{{ url_for('eventos_bp.eliminar_evento', id_evento=evento.id_evento) }}"
                        method="POST"
                        style="display: inline"
                      >
                        <button
                          type="submit"
                          class="btn btn-link p-0 text-danger"
                          title="Eliminar evento"
                          onclick="return confirm('¿Seguro que querés eliminar este evento?')"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      No hay eventos cargados
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-8 d-flex flex-column justify-content-center">
            <!-- Resumen opcional -->
          </div>

          <div
            class="col-md-4 d-flex justify-content-end align-items-center gap-2"
          >
            <!-- Botón Agregar con color personalizado -->
              {% if current_user.es_administrador() %}
            <a
              href="{{ url_for('eventos_bp.agregar_evento') }}"
              class="btn px-4"
              style="background-color: #b90603; color: white; border: none"
            >
              Agregar
            </a>
             {% endif %}

            <!-- Botón Volver -->
            <a
              href="{{ url_for('eventos_bp.eventos') }}"
              class="btn btn-outline-secondary"
            >
              <i class="bi me-2"></i>Recargar
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/eventos.js') }}"></script>

{% endblock %}
