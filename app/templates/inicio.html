{% extends 'base.html' %} {% block title %} Pagina de inicio {% endblock %} {%
block content %}
<div class="calendar-page">
  <div class="calendar-container">
    <!-- Row superior -->
    <div class="top-buttons">
      <div class="d-flex flex-column flex-md-row justify-content-md-end gap-2">
        <button
          class="btn btn-custom d-flex align-items-center justify-content-center"
        >
          <i class="bi bi-image me-2"></i> <span>Descargar como imagen</span>
        </button>

        <button
          type="button"
          class="btn btn-outline-primary d-flex align-items-center justify-content-center"
          id="btnCambiarVista"
          onclick="toggleVista()"
        >
          <i id="iconoVista" class="bi bi-calendar-week me-2"></i>
          <span id="textoVista">Semana</span>
        </button>
      </div>
    </div>

    <!-- REEMPLAZO: antes era [Aqu√≠ ir√° el calendario] -->
    <div id="calendar"></div>

    <!-- Row inferior -->
    <div class="bottom-buttons">
      <div class="d-flex flex-column flex-md-row justify-content-center gap-3">
        {% if current_user.es_administrador() %}
        <a
          href="{{url_for('eventos_bp.agregar_evento')}}"
          class="btn btn-custom px-5 py-2"
        >
          Ingresar
        </a>
        {% endif %}

        <a
          href="{{ url_for('eventos_bp.eventos') }}"
          class="btn btn-custom px-5 py-2"
        >
          Consultar
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal para detalle del evento -->
<div
  class="modal fade"
  id="eventoModal"
  tabindex="-1"
  aria-labelledby="eventoModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventoModalLabel">Detalle del Evento</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Descripci√≥n:</strong> <span id="modalDescripcion"></span></p>
        <p><strong>Fecha inicio:</strong> <span id="modalInicio"></span></p>
        <p><strong>Fecha fin:</strong> <span id="modalFin"></span></p>
        <p>
          <strong>Observaciones:</strong> <span id="modalObservaciones"></span>
        </p>
        <p><strong>Monto total:</strong> $<span id="modalMonto"></span></p>
        <p><strong>Adeuda:</strong> <span id="modalAdeuda"></span></p>
        <p><strong>DNI:</strong> <span id="modalDni"></span></p>
        <p>
          <strong>Responsable apertura:</strong>
          <span id="modalResponsableApertura"></span>
        </p>
        <p>
          <strong>Responsable cierre:</strong>
          <span id="modalResponsableCierre"></span>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  let calendar;
  let vistaActual = "dayGridMonth"; // Vista inicial es mes

  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      height: "100%",
      contentHeight: "100%",
      locale: "es",
      fixedWeekCount: false,
      selectable: true,
      editable: true,
      events: "{{ url_for('eventos_bp.eventos_json') }}",
      eventDisplay: "block",
      displayEventTime: false,

      /*dayCellContent: (arg) => {
        // deja el n√∫mero del d√≠a nom√°s
        return { html: arg.date.getDate() };
      },*/

      views: {
        //Vista mes
        dayGridMonth: {
          displayEventTime: false,
        },
        timeGridWeek: {
          allDaySlot: false, // no queremos la fila "Todo el d√≠a"
          slotMinTime: "08:00:00",
          slotMaxTime: "24:00:00",
          slotDuration: "02:00:00",
          displayEventTime: true,
          nowIndicator: false,
          expandRows: true,
        },
      },

      buttonText: {
        today: "Hoy",
        month: "Mes",
        week: "Semana",
      },

      /*eventClick: function (info) {
        console.log("‚úÖ eventClick ejecut√°ndose");
        console.log("Evento:", info.event);
        console.log("ExtendedProps:", info.event.extendedProps);

        const evento = info.event;
        const props = evento.extendedProps || {};

        // Verificar que el modal existe
        const modalElement = document.getElementById("eventoModal");
        console.log("Modal element:", modalElement);

        if (!modalElement) {
          console.error("‚ùå No se encontr√≥ el elemento eventoModal");
          return;
        }

        // Llenar el modal
        document.getElementById("modalDescripcion").textContent =
          evento.title || "Sin descripci√≥n";
        document.getElementById("modalInicio").textContent = evento.start
          ? evento.start.toLocaleDateString("es-ES")
          : "No especificada";
        document.getElementById("modalFin").textContent = evento.end
          ? new Date(evento.end.getTime() - 86400000).toLocaleDateString(
              "es-ES"
            )
          : "No especificada";
        document.getElementById("modalObservaciones").textContent =
          props.observaciones || "Sin observaciones";
        document.getElementById("modalMonto").textContent =
          props.monto_total?.toLocaleString("es-ES") || "0";
        document.getElementById("modalAdeuda").textContent = props.adeuda
          ? "S√≠"
          : "No";
        document.getElementById("modalDni").textContent =
          props.dni || "No especificado";
        document.getElementById("modalResponsableApertura").textContent =
          props.responsable_apertura || "No especificado";
        document.getElementById("modalResponsableCierre").textContent =
          props.responsable_cierre || "No especificado";

        // Mostrar el modal
        console.log("Intentando abrir modal...");
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log("Modal.show() ejecutado");

        info.jsEvent.preventDefault();
      },*/

      eventClick: function (info) {
        console.log("üéØ EVENTO CLICKEADO");

        const evento = info.event;
        const props = evento.extendedProps || {};

        // Llenar el modal con los datos del evento
        document.getElementById("modalDescripcion").textContent =
          evento.title || "Sin descripci√≥n";

        // Formatear fechas en espa√±ol
        document.getElementById("modalInicio").textContent = evento.start
          ? evento.start.toLocaleDateString("es-ES")
          : "No especificada";

        document.getElementById("modalFin").textContent = evento.end
          ? new Date(evento.end.getTime() - 86400000).toLocaleDateString(
              "es-ES"
            )
          : "No especificada";

        document.getElementById("modalObservaciones").textContent =
          props.observaciones || "Sin observaciones";

        document.getElementById("modalMonto").textContent =
          props.monto_total?.toLocaleString("es-ES") || "0";

        document.getElementById("modalAdeuda").textContent = props.adeuda
          ? "S√≠"
          : "No";

        document.getElementById("modalDni").textContent =
          props.dni || "No especificado";
        document.getElementById("modalResponsableApertura").textContent =
          props.responsable_apertura || "No especificado";
        document.getElementById("modalResponsableCierre").textContent =
          props.responsable_cierre || "No especificado";

        // Mostrar el modal
        const modalElement = document.getElementById("eventoModal");
        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        console.log("‚úÖ Modal abierto correctamente");

        info.jsEvent.preventDefault();
        return false;
      },
    });

    calendar.render();
  });

  function toggleVista() {
    if (!calendar) return;

    const iconoVista = document.getElementById("iconoVista");
    const textoVista = document.getElementById("textoVista");

    if (vistaActual === "dayGridMonth") {
      calendar.changeView("timeGridWeek");
      vistaActual = "timeGridWeek";

      iconoVista.className = "bi bi-calendar-month me-2";
      textoVista.textContent = "Mes";
    } else {
      calendar.changeView("dayGridMonth");
      vistaActual = "dayGridMonth";

      iconoVista.className = "bi bi-calendar-week me-2";
      textoVista.textContent = "Semana";
    }
  }

  /*select: function (info) {
        const title = prompt("T√≠tulo del evento:");
        if (title) {
          fetch("/events", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title: title,
              start: info.startStr,
              end: info.endStr,
            }),
          }).then(() => calendar.refetchEvents());
        }
      },*/

  /*eventClick: function (info) {
        if (confirm("¬øEliminar este evento?")) {
          fetch("/delete/" + info.event.id, { method: "DELETE" }).then(() =>
            calendar.refetchEvents()
          );
        }
      },
    });*/
</script>

{% endblock %}
