{% extends 'base.html' %}
{% block title %} Detalles del Evento {% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex align-items-center mb-3">
    <a href="{{ url_for('eventos_bp.eventos') }}" class="text-muted me-3" aria-label="Volver">
      <i class="bi bi-arrow-left fs-4"></i>
    </a>
    <div>
      <h2 class="m-0">Detalles del Evento</h2>
      {% if evento.fecha_inicio %}
        <small class="text-muted">Fecha: {{ evento.fecha_inicio.strftime('%d/%m/%Y') }}</small>
      {% endif %}
    </div>
  </div>

  <div class="d-flex justify-content-center">
    <div class="card card-main w-100" style="max-width:1100px;">
      <div class="card-body">
        <div class="row g-3">
          <!-- Left: Detalles principales -->
          <div class="col-md-8">
            <div class="section-card">
              <h5 class="mb-3">Datos del evento</h5>

              <div class="mb-2">
                <div class="detalle-label">Descripción</div>
                <div class="detalle-value">{{ evento.descripcion }}</div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-2">
                  <div class="detalle-label">ID</div>
                  <div class="detalle-value">{{ evento.id_evento }}</div>
                </div>
                <div class="col-md-6 mb-2">
                  <div class="detalle-label">Nro. de Recibo</div>
                  <div class="detalle-value">{{ evento.nro_recibo or 'N/A' }}</div>
                </div>
              </div>

              <div class="row">
                <!-- Fecha + Hora inicio -->
                <div class="col-md-6 mb-2">
                  <div class="detalle-label">Fecha inicio</div>

                  {# preparar start_dt / end_dt si la columna viene en formato "start|end" o como datetimes separados #}
                  {% set start_dt = None %}
                  {% set end_dt = None %}
                  {% if evento.fecha_inicio %}
                    {% if evento.fecha_inicio is string and '|' in evento.fecha_inicio %}
                      {% set parts = evento.fecha_inicio.split('|') %}
                      {% set start_dt = parts[0] %}
                      {% set end_dt = parts[1] %}
                    {% else %}
                      {% set start_dt = evento.fecha_inicio %}
                      {% set end_dt = evento.fecha_fin if evento.fecha_fin is defined else None %}
                    {% endif %}
                  {% endif %}

                  <div class="detalle-value">
                    {% if start_dt %}
                      {% if start_dt is string %}
                        {{ start_dt.split(' ')[0] }}
                      {% else %}
                        {{ start_dt.strftime('%d/%m/%Y') }}
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}

                    <div class="text-muted mt-1"><small>
                      Hora inicio:
                      {% if start_dt %}
                        {% if start_dt is string %}
                          {% if ' ' in start_dt %}
                            {{ start_dt.split(' ')[1][0:5] }}
                          {% else %}
                            {{ start_dt[0:5] }}
                          {% endif %}
                        {% else %}
                          {{ start_dt.strftime('%H:%M') }}
                        {% endif %}
                      {% else %}
                        —
                      {% endif %}
                    </small></div>
                  </div>
                </div>

                <!-- Fecha + Hora fin -->
                <div class="col-md-6 mb-2">
                  <div class="detalle-label">Fecha fin</div>
                  <div class="detalle-value">
                    {% if end_dt %}
                      {% if end_dt is string %}
                        {{ end_dt.split(' ')[0] }}
                      {% else %}
                        {{ end_dt.strftime('%d/%m/%Y') }}
                      {% endif %}
                    {% else %}
                      {# si no vino split, mostrar fecha_fin si existe y es distinta #}
                      {% if evento.fecha_fin and evento.fecha_fin != evento.fecha_inicio %}
                        {% if evento.fecha_fin is string %}
                          {{ evento.fecha_fin.split(' ')[0] }}
                        {% else %}
                          {{ evento.fecha_fin.strftime('%d/%m/%Y') }}
                        {% endif %}
                      {% else %}
                        —
                      {% endif %}
                    {% endif %}

                    <div class="text-muted mt-1"><small>
                      Hora final:
                      {% set time_src = end_dt if end_dt else (evento.fecha_fin if evento.fecha_fin is defined else None) %}
                      {% if time_src %}
                        {% if time_src is string %}
                          {% if ' ' in time_src %}
                            {{ time_src.split(' ')[1][0:5] }}
                          {% else %}
                            {{ time_src[0:5] }}
                          {% endif %}
                        {% else %}
                          {{ time_src.strftime('%H:%M') }}
                        {% endif %}
                      {% else %}
                        —
                      {% endif %}
                    </small></div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-2">
                  <div class="detalle-label">Monto total</div>
                  <div class="detalle-value">${{ evento.monto_total | float | round(2) }}</div>
                </div>
                <div class="col-md-6 mb-2">
                  <div class="detalle-label">Adeuda</div>
                  <div class="detalle-value">{{ 'Sí' if evento.adeuda else 'No' }}</div>
                </div>
              </div>

              <div class="mb-2">
                <div class="detalle-label">Observaciones</div>
                <div class="detalle-value">{{ evento.observaciones or 'Sin observaciones' }}</div>
              </div>
            </div>
          </div>

          <!-- Right: Cliente y responsables -->
          <div class="col-md-4">
            <div class="section-card mb-3">
              <h6 class="mb-2">Cliente / Responsable</h6>
              <p class="mb-1"><strong>Nombre:</strong> {{ evento.cliente.nombre }} {{ evento.cliente.apellido }}</p>
              <p class="mb-1"><strong>DNI:</strong> {{ evento.cliente.dni }}</p>
              <p class="mb-1"><strong>Teléfono:</strong> {{ evento.cliente.telefono }}</p>
              <p class="mb-1"><strong>Institución:</strong> {{ evento.cliente.institucion or 'N/A' }}</p>
            </div>

            <div class="section-card">
              <h6 class="mb-2">Responsables de la llave</h6>
              <p class="mb-1"><strong>Apertura:</strong>
                {% if evento.responsable_apertura %}
                  {{ evento.responsable_apertura.nombre }} {{ evento.responsable_apertura.apellido }}
                {% else %}
                  No asignado
                {% endif %}
              </p>
              <p class="mb-1"><strong>Cierre:</strong>
                {% if evento.responsable_cierre %}
                  {{ evento.responsable_cierre.nombre }} {{ evento.responsable_cierre.apellido }}
                {% else %}
                  No asignado
                {% endif %}
              </p>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <a href="{{ url_for('ingresos.pagos', id_evento=evento.id_evento) }}" class="btn btn-outline-secondary">
            <i class="bi bi-wallet2 me-1"></i> Ver pagos
            {% if evento.pagos %}
              <span class="badge bg-light text-dark ms-2">{{ evento.pagos|length }}</span>
            {% endif %}
          </a>

          <a href="{{ url_for('ingresos.agregar_pago', id_evento=evento.id_evento) }}" class="btn btn-custom">
            <i class="bi bi-cash-stack me-1"></i> Agregar pago
          </a>

          <a href="{{ url_for('eventos_bp.eventos') }}" class="btn btn-outline-secondary">Volver</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
